<!DOCTYPE html>
<html>
<head>
    <title>PABRIK Menu Tester</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-item { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background-color: #d4edda; }
        .failed { background-color: #f8d7da; }
        .testing { background-color: #fff3cd; }
        #progress { font-weight: bold; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>PABRIK Module Menu Testing</h1>
    <div id="progress">Progress: 0 / 78</div>
    <button onclick="startTesting()">Start Testing</button>
    <button onclick="exportResults()">Export Results</button>
    <div id="results"></div>

    <iframe id="testFrame" style="display:none;" width="1" height="1"></iframe>

    <script>
    const menuItems = {
        'Transaksi': [
            {id: 301, name: 'Pengoperasian Pabrik', action: 'pabrik_pengolahan'},
            {id: 302, name: 'Pemeliharaan Mesin', action: 'pabrik_perbaikan'},
            {id: 303, name: 'Stok CPO/PK', action: 'pabrik_hasil'},
            {id: 300, name: 'Sortasi Buah(lama tdk dipakai)', action: 'pabrik_sortasi'},
            {id: 620, name: 'Timbangan', action: 'pabrik_timbangan'},
            {id: 721, name: 'Produksi Harian', action: 'pabrik_produksi'},
            {id: 853, name: 'Timbangan Pembeli', action: 'pabrik_timbangan_pembeli'},
            {id: 1047, name: 'Target Eksternal', action: 'pabrik_taksasi'},
            {id: 1066, name: 'Sortasi Buah', action: 'pabrik_sortasi2'},
            {id: 1155, name: 'Stok Produk Lain', action: 'pabrik_stokProduk'},
            {id: 1158, name: ' BA Pengurangan Stok', action: 'pabrik_pembersihantangki'},
            {id: 1229, name: 'Data Press dan Air', action: 'pabrik_datapress'},
            {id: 1230, name: 'BA Transportir', action: 'pabrik_batransportir'},
            {id: 1245, name: 'Data Mesin', action: 'pabrik_machinery'},
            {id: 1239, name: 'HM/Jam Jalan', action: 'pabrik_hm'},
            {id: 1243, name: 'Pemeliharaan Prediktif', action: 'pabrik_prediktif'},
            {id: 1253, name: 'Thickness', action: 'pabrik_thickness'},
            {id: 1260, name: 'Verifikasi Ampere', action: 'pabrik_verifikasi_ampere'},
            {id: 1264, name: 'Earth Test', action: 'pabrik_earthtest'},
            {id: 1266, name: 'Preventatif Panel', action: 'pabrik_preventifpanel'},
            {id: 1268, name: 'Megger Test', action: 'pabrik_meggertest'},
            {id: 1271, name: 'Retur/Outspec', action: 'pabrik_outspec'},
            {id: 1277, name: 'Material Ballance', action: 'pabrik_materialballance'},
            {id: 1280, name: 'Limbah B3', action: 'pabrik_limbahb3'},
            {id: 1288, name: 'Grading Actual TBS', action: 'pabrik_sortasli'}
        ],
        'Laporan': [
            {id: 783, name: 'Laporan Produksi Bulanan', action: 'pabrik_2produksiHarian_v1'},
            {id: 732, name: 'Laporan Produksi Tahunan', action: 'pabrik_2produksiHarian'},
            {id: 748, name: 'Laporan Penerimaan TBS', action: 'pabrik_2penerimaantbs'},
            {id: 750, name: 'Laporan Pengiriman', action: 'pabrik_2pengiriman'},
            {id: 627, name: 'Pemenuhan Kontrak', action: 'pmn_laporanPemenuhanKontrak'},
            {id: 419, name: 'Stok CPO/PK', action: 'pabrik_4persediaan'},
            {id: 621, name: 'Timbangan', action: 'pabrik_2timbangan'},
            {id: 1006, name: 'Pabrik Loses', action: 'pabrik_2loses'},
            {id: 418, name: 'Pengolahan', action: 'pabrik_2pengolahan_rev'},
            {id: 1004, name: 'Pengolahan Detail', action: 'pabrik_2pengolahanv2'},
            {id: 610, name: 'Perawatan Mesin (TIDAK DI PAKAI)', action: 'pabrik_laporanPerawatanMesin'},
            {id: 733, name: 'Laporan Sortasi Intenal', action: 'pabrik_2laporanSortasiPabrik'},
            {id: 1059, name: 'Stagnasi', action: 'pabrik_2stagnasi'},
            {id: 1060, name: 'Rekap DO', action: 'pmn_2rekapdo'},
            {id: 1078, name: 'Laporan Sortasi Eksternal', action: 'pabrik_2laporanSortasiPabrik2'},
            {id: 1152, name: 'Harga TBS', action: 'pabrik_2hargatbs'},
            {id: 1156, name: 'Job Card Report /  Perawatan Mesin', action: 'pabrik_2perbaikan'},
            {id: 1176, name: 'Biaya Pabrik', action: 'pabrik_2biaya'},
            {id: 1217, name: 'Rekap Budget vs Real Biaya PKS', action: 'pabrik_2biayav2'},
            {id: 1206, name: 'Sortasi v2', action: 'pabrik_2sortasi'},
            {id: 1216, name: 'Sortasi v3', action: 'pabrik_2sortasiv'},
            {id: 1073, name: 'Laporan Pembelian TBS', action: 'pabrik_2hargatbs'},
            {id: 1213, name: 'Stock Produk Lain', action: 'pabrik_2stokProduk'},
            {id: 1223, name: 'LHP', action: 'pabrik_lhp'},
            {id: 1257, name: 'Laporan Hutang Transportir', action: 'pmn_laphutangtransportir'},
            {id: 1242, name: 'Data Mesin', action: 'pabrik_lapmachinery'},
            {id: 1256, name: 'Penilaian Kondisi Mesin', action: 'pabrik_lapPenilaianmachinery'},
            {id: 1241, name: 'Laporan HM/Jam Jalan', action: 'pabrik_laphm'},
            {id: 1246, name: 'HM Service Mesin', action: 'pabrik_lapservicehm'},
            {id: 1244, name: 'Pemeliharaan Prediktif', action: 'pabrik_lapprediktif'},
            {id: 1254, name: 'Thickness', action: 'pabrik_lapthickness'},
            {id: 1261, name: 'Verifikasi Ampere', action: 'pabrik_lapverifikasi_ampere'},
            {id: 1265, name: 'Earth Test', action: 'pabrik_lap_earthtest'},
            {id: 1267, name: 'Preventatif Panel', action: 'pabrik_lap_preventifpanel'},
            {id: 1269, name: 'Megger Test', action: 'pabrik_lap_meggertest'},
            {id: 1258, name: 'Laporan Grading', action: 'pabrik_laporan_grading'},
            {id: 1278, name: 'Laporan Material Ballance', action: 'pabrik_lap_materialballance'},
            {id: 1281, name: 'Laporan Limbah B3', action: 'pabrik_lap_limbahb3'},
            {id: 1282, name: 'Laporan Retur/Outspec', action: 'pabrik_lap_outspec'},
            {id: 1289, name: 'Lap Grading Actual', action: 'pabrik_lapfull_grading'}
        ],
        'Proses': [
            {id: 728, name: 'Upload Data Vendor', action: 'pabrik_3uploadDataVendor'},
            {id: 735, name: 'Posting Perawatan Mesin', action: 'pabrik_3posting_perawatan_mesin'}
        ],
        'Setup': [
            {id: 428, name: 'Shift', action: 'pabrik_5shift'},
            {id: 429, name: 'Tangki', action: 'pabrik_5tangki'},
            {id: 1160, name: 'Kalibrasi Tinggi Tangki', action: 'pabrik_5tinggitangki'},
            {id: 1162, name: 'Suhu', action: 'pabrik_5suhu'},
            {id: 1163, name: 'Suhu Standard Kalibrasi', action: 'pabrik_5suhustandardkalibrasi'},
            {id: 734, name: 'Fraksi', action: 'pabrik_5fraksi'},
            {id: 877, name: 'Potongan Fraksi', action: 'pabrik_5potFraksi'},
            {id: 1151, name: 'Harga TBS', action: 'pabrik_5hargatbs'},
            {id: 1240, name: 'Setup HM Mesin', action: 'pabrik_hm_setup'}
        ]
    };

    let testResults = [];
    let currentIndex = 0;
    let allItems = [];

    // Flatten menu items
    for (let category in menuItems) {
        menuItems[category].forEach(item => {
            allItems.push({...item, category: category});
        });
    }

    function testMenuItem(item, callback) {
        const url = 'http://localhost/erpmill/' + item.action + '.php';
        const resultDiv = document.getElementById('result-' + item.id);
        resultDiv.className = 'test-item testing';
        resultDiv.innerHTML = `<strong>${item.category} > ${item.name}</strong><br>Testing: ${url}<br>Status: Loading...`;

        const iframe = document.getElementById('testFrame');
        const startTime = Date.now();

        let timeout = setTimeout(() => {
            const loadTime = Date.now() - startTime;
            resultDiv.className = 'test-item failed';
            resultDiv.innerHTML = `<strong>${item.category} > ${item.name}</strong><br>URL: ${url}<br>Status: TIMEOUT (>10s)<br>Load Time: ${loadTime}ms`;
            testResults.push({
                ...item,
                url: url,
                status: 'TIMEOUT',
                loadTime: loadTime,
                errors: ['Page load timeout (>10 seconds)']
            });
            callback();
        }, 10000);

        iframe.onload = function() {
            clearTimeout(timeout);
            const loadTime = Date.now() - startTime;

            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const title = iframeDoc.title;
                const hasError = iframeDoc.body.innerHTML.toLowerCase().includes('error') ||
                               iframeDoc.body.innerHTML.toLowerCase().includes('fatal') ||
                               iframeDoc.body.innerHTML.toLowerCase().includes('warning');

                if (hasError) {
                    resultDiv.className = 'test-item failed';
                    resultDiv.innerHTML = `<strong>${item.category} > ${item.name}</strong><br>URL: ${url}<br>Status: FAILED (PHP Error detected)<br>Load Time: ${loadTime}ms<br>Title: ${title}`;
                    testResults.push({
                        ...item,
                        url: url,
                        status: 'FAILED',
                        loadTime: loadTime,
                        errors: ['PHP Error detected in page']
                    });
                } else {
                    resultDiv.className = 'test-item success';
                    resultDiv.innerHTML = `<strong>${item.category} > ${item.name}</strong><br>URL: ${url}<br>Status: SUCCESS<br>Load Time: ${loadTime}ms<br>Title: ${title}`;
                    testResults.push({
                        ...item,
                        url: url,
                        status: 'SUCCESS',
                        loadTime: loadTime,
                        errors: []
                    });
                }
            } catch (e) {
                resultDiv.className = 'test-item success';
                resultDiv.innerHTML = `<strong>${item.category} > ${item.name}</strong><br>URL: ${url}<br>Status: SUCCESS (cross-origin)<br>Load Time: ${loadTime}ms`;
                testResults.push({
                    ...item,
                    url: url,
                    status: 'SUCCESS',
                    loadTime: loadTime,
                    errors: []
                });
            }

            callback();
        };

        iframe.onerror = function() {
            clearTimeout(timeout);
            const loadTime = Date.now() - startTime;
            resultDiv.className = 'test-item failed';
            resultDiv.innerHTML = `<strong>${item.category} > ${item.name}</strong><br>URL: ${url}<br>Status: FAILED (Load Error)<br>Load Time: ${loadTime}ms`;
            testResults.push({
                ...item,
                url: url,
                status: 'FAILED',
                loadTime: loadTime,
                errors: ['Failed to load page']
            });
            callback();
        };

        iframe.src = url;
    }

    function testNext() {
        if (currentIndex >= allItems.length) {
            document.getElementById('progress').innerHTML = `Testing Complete: ${allItems.length} / ${allItems.length}`;
            console.log('All tests complete!', testResults);
            return;
        }

        const item = allItems[currentIndex];
        document.getElementById('progress').innerHTML = `Progress: ${currentIndex + 1} / ${allItems.length}`;

        testMenuItem(item, () => {
            currentIndex++;
            setTimeout(testNext, 1000); // Wait 1 second between tests
        });
    }

    function startTesting() {
        testResults = [];
        currentIndex = 0;
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        // Create result divs for all items
        allItems.forEach(item => {
            const div = document.createElement('div');
            div.id = 'result-' + item.id;
            div.className = 'test-item';
            div.innerHTML = `<strong>${item.category} > ${item.name}</strong><br>Status: Pending...`;
            resultsDiv.appendChild(div);
        });

        testNext();
    }

    function exportResults() {
        const summary = {
            totalTested: testResults.length,
            totalSuccess: testResults.filter(r => r.status === 'SUCCESS').length,
            totalFailed: testResults.filter(r => r.status === 'FAILED' || r.status === 'TIMEOUT').length
        };

        const report = {
            summary: summary,
            results: testResults
        };

        const dataStr = JSON.stringify(report, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'pabrik_menu_test_results.json';
        link.click();
    }
    </script>
</body>
</html>
